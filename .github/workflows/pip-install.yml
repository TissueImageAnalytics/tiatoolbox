# This workflow will install the package as is on the github default branch using pip

name: pip Install

on:
  push:
    branches: [ develop, pre-release, master, main ]
    tags: v*
  pull_request:
    branches: [ develop, pre-release, master, main ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        python-version: ["3.7", "3.8", "3.9", "3.10"]
        os: [ubuntu-22.04, windows-latest]
    steps:
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install Linux Dependencies (OpenSlide & OpenJPEG)
      if: runner.os == 'Linux'
      run: |
        sudo apt update
        sudo apt-get install -y libopenslide-dev openslide-tools libopenjp2-7 libopenjp2-tools
        python -m pip install --upgrade pip
    - name: Install Windows Dependencies (OpenSlide & OpenJPEG)
      if: runner.os == 'Windows'
      run: |
        # Install OpenJPEG
        git clone https://github.com/uclouvain/openjpeg.git
        cd openjpeg
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make
        make install
        make clean
        # Install OpenSlide
        choco install wget --no-progress
        wget https://github.com/openslide/openslide-winbuild/releases/download/v20220811/openslide-win64-20220811.zip
        7z e openslide-win64-20220811.zip -oopenslide-win64
        echo "$(realpath ./openslide-win64)" >> $GITHUB_PATH
    - name: Print Dependency Version Information
      run: |
        echo "---SQlite---"
        sqlite3 --version
        sqlite3 ":memory:" -list ".output stdout" "pragma compile_options" ".exit"
        echo "---Openslide---"
        openslide-quickhash1sum --version
        echo "---OpenJPEG---"
        opj_dump -h | head -n 5
    - name: pip Install From GitHub Repo
      run: |
        python -m pip install git+https://github.com/TissueImageAnalytics/tiatoolbox
    - name: Test Import
      run: python -c "import tiatoolbox"
